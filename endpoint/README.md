# Compute Endpoint Configuration & Codes

This directory contains the configuration for the globus-compute-endpoint and
the Python library that contains the compute capabilities.

[[_TOC_]]

---

## 1. Overview

The setup currently is designed to run on ALCF/Polaris and NERSC/Perlmutter.
The `config/` directory contains the following endpoint configurations:

- `<system>/compute-portal-<system>-1-node`: For functions that do not benefit from
  additional resources, such as finding individual halos and galaxies and calculating
  surface densities.

### 1.1. Implemented Features/Functions

The implemented features can be found in `hcp_endpoint/scripts/<feature>`

The corresponding Globus-Compute functions that call those features via subprocess
are in `functions/<feature>`

### 1.2. Currently Supported Datasets
---

## 2. Installation

### 2.1. Prerequisites

#### Repository Location

The endpoint configuration files currently assume that the repository is located
under `~/compute-portal`. Therefore, either change the configuration files
or make sure to clone the repository to your home, i.e.

```bash
cd ~
git clone https://github.com/michaelbuehlmann/ComputePortalTemplate.git -C compute-portal
```

#### Python

The endpoint library requires a recent python version (`^3.11`).
Depending on the system you're running on, there may be a source file in
`compute-portal/endpoint/env` that loads the required modules. For example
on **Polaris**, run

```bash
source env/polaris.env.sh
```

#### Poetry

The Python library uses [poetry](https://python-poetry.org) to manage
dependencies. If not already installed, follow the
[documentation](https://python-poetry.org/docs) to set up poetry on the system.

Change the default location of the virtual environments
generated by poetry to the project folder (`./.venv` instead of
`~/.local`) by running

```bash
    # this will create virtual environments in the project directory (.venv/)
    # instead of the users home directory
    poetry config virtualenvs.in-project true
```

If you've installed poetry within a `conda` environment, you may need to install the [poetry-conda](https://pypi.org/project/poetry-conda/) plugin for the above command to work.


#### Environment
Go to the Globus portal -> Settings -> Developer to create a new (thick) Client
(or use an existing client) that we will use to interact with the Globus API.
Create a .env file in this directory with the following content:

```bash
GLOBUS_CLIENT_ID="<Client Application UUID>"
```


#### Production systems

We want the endpoint to run as a Globus Service Account (i.e, the application you
have setup on the Globus Developer Page). For this, we need to store the client
credentials on the system where the endpoint is running. We will use `.env` files
for this.

With poetry, add the `dotenv` plugin to automatically load variables defined
in `.env` when sourcing the virtual environment through `poetry shell`:

```bash
    poetry self add poetry-plugin-dotenv
```

From the Globus developer page, go to the app settings and configure a new
secret. Then add the Client ID and secret to
`hacc-compute-portal/hcp_endpoint/.env`:

```bash
# Only for the production
GLOBUS_COMPUTE_CLIENT_ID="<Compute Service Account Globus ID>"
GLOBUS_COMPUTE_CLIENT_SECRET="<Compute Service Account Secret>"
```

### 2.2. Setup

1.  Install the python library: Within `hcp_endpoint` (the folder where this
    README.md is located), the following command will install all required
    dependencies:

    ```bash
    poetry install
    ```

    If `virtualenvs.in-project` was set (above), then the virtual environment
    will be created locally in `.venv`. It can be activated either by
    `source .venv/bin/activate` or `poetry shell`.

2.  Create the globus compute endpoints by running

    ```bash
    globus-compute-endpoint configure --endpoint-config config/polaris/compute-portal-polaris-1-node.yaml hacc-compute-portal-polaris-1-node
    ```

    Replace `polaris` with the system you are installing the endpoints for.

    This creates the file `~/.globus_compute/<endpoint_name>/config.yaml`.
    Edit the configuration files if necessary (e.g., change the path to this
    repository in `worker_init`)

3.  Start the endpoint by running
    ```bash
    globus-compute-endpoint start <endpoint_name>
    ```

4.  Register the compute functions by running
    ```bash
    hcp-setup-endpoint <system>
    ```

5.  If the previous script runs successfully, it will ask you to restart the
    compute endpoints. Do this by running
    ```bash
    globus-compute-endpoint restart <endpoint_name>
    ```

The endpoints and their status can be listed by running

```bash
globus-compute-endpoint list
```

and by visiting the [Globus Compute website](https://app.globus.org/compute).

---

## 3. Development

(documentation to be added)
