# Entry Point Configuration & Codes

This directory contains the configuration and code for the "entry-point" stage
compute endpoint.

[[__TOC_]]

---

## 1. Overview

This entrypoint compute endpoint can be run on any Linux (or Mac, although
not officially supported by Globus) system. In the current flow setup, the
first stage of the flow (which we call "entry-point"), provides the necessary
inputs for the next stage, in particular the endpoint_uuid (which system to run
on) and the function_uuid (which function to execute), given the selected
dataset and the selected feature.


## 2. Installation

### 2.1. Prerequisites

#### Repository Location

TODO: add details, `$HCP_REPO` variable

#### Python

The endpoint library requires a recent python version (`^3.11`).

#### Poetry

The Python library uses [poetry](https://python-poetry.org) to manage
dependencies. If not already installed, follow the
[documentation](https://python-poetry.org/docs) to set up poetry on the system.

Change the default location of the virtual environments
generated by poetry to the project folder (`./.venv` instead of
`~/.local`) by running

```bash
    # this will create virtual environments in the project directory (.venv/)
    # instead of the users home directory
    poetry config virtualenvs.in-project true
```
If you've installed poetry within a `conda` environment, you may need to install the [poetry-conda](https://pypi.org/project/poetry-conda/) plugin for the above command to work.


#### Environment
Go to the Globus portal -> Settings -> Developer to create a new (thick) Client
(or use an existing client) that we will use to interact with the Globus API.
Create a .env file in this directory with the following content:

```bash
GLOBUS_CLIENT_ID="<Client Application UUID>"
```


#### Production systems

We want the endpoint to run as a Globus Service Account (i.e, the application you
have setup on the Globus Developer Page). For this, we need to store the client
credentials on the system where the endpoint is running. We will use `.env` files
for this.

With poetry, add the `dotenv` plugin to automatically load variables defined
in `.env` when sourcing the virtual environment through `poetry shell`:

```bash
    poetry self add poetry-plugin-dotenv
```

From the Globus developer page, go to the app settings and configure a new
secret. Then add the Client ID and secret to
`hacc-compute-portal/hcp_entrypoint/.env`:

```bash
# Only for the production
GLOBUS_COMPUTE_CLIENT_ID="<Compute Service Account Globus ID>"
GLOBUS_COMPUTE_CLIENT_SECRET="<Compute Service Account Secret>"
```

### 2.2. Setup

1.  Install the python library: Within `hcp_entrypoint` (the folder where this
    README.md is located), the following command will install all required
    dependencies:

    ```bash
    poetry install
    ```

    If `virtualenvs.in-project` was set (above), then the virtual environment
    will be created locally in `.venv`. It can be activated either by
    `source .venv/bin/activate` or `poetry shell`.

2.  Create the globus compute endpoints by running

    ```bash
    globus-compute-endpoint configure --endpoint-config config/hacc-compute-portal-entry-point.yaml hacc-compute-portal-entry-point

    ```

    This creates the file `~/.globus_compute/hacc-compute-portal-entry-point/config.yaml`.
    Edit the configuration files if necessary (e.g., change the path to this
    repository in `worker_init`)

3.  Start the endpoint by running
    ```bash
    globus-compute-endpoint start hacc-compute-portal-entry-point
    ```

4.  Register the compute functions by running
    ```bash
    hcp-setup-entry-fct
    ```

    If the endpoint is running as a systemd service (prod), make sure to add
    `--attach-endpoint` to the setup script.

5.  If the previous script runs successfully, it will ask you to restart the
    compute endpoints. Do this by running
    ```bash
    globus-compute-endpoint restart hacc-compute-portal-entry-point
    ```

The endpoints and their status can be listed by running

```bash
globus-compute-endpoint list
```

and by visiting the [Globus Compute website](https://app.globus.org/compute).

---
